# meta-ea-rauc
Yocto meta layer for integration of RAUC on Embedded Artists CoM/SoM

## What is RAUC?

[RAUC](https://rauc.io/) is a lightweight update client that runs on Embedded 
Linux devices and reliably controls the procedure of updating the device with 
new firmware.

## Add RAUC support to ea-image-base build

### New meta layers

Go to the sources directory for your build (called `ea-bsp` below).

```
cd ea-bsp/sources/
```

Clone [meta-rauc](https://github.com/rauc/meta-rauc). In this example we are using the `mickledore` branch. 

```
git clone -b mickledore https://github.com/rauc/meta-rauc.git
```

If not already included via ea-yocto-base, clone meta-ea-rauc. In this example we are 
using the `mickledore` branch. 

```
git clone -b mickledore https://github.com/embeddedartists/meta-ea-rauc.git
```

Add the new repositories to the end of `conf/bblayers.conf`:

```
BBLAYERS += " ${BSPDIR}/sources/meta-rauc "
BBLAYERS += " ${BSPDIR}/sources/meta-ea-rauc "
```

### Generate development certificates

RAUC is using [public key infrastructure](https://rauc.readthedocs.io/en/latest/examples.html#pki-setup)
to sign and verify updates. If you don't already have your own certificates a script is provided in 
`meta-rauc` that can generate development certificates. 

```
cd ea-bsp/sources/meta-rauc/scripts/
./openssl-ca.sh
```

This will generate a folder `openssl-ca/` that contains the development certificates and keys.

### Update local.conf

Your `ea-bsp/conf/local.conf` must be updated with the following to add RAUC support. 

```
DISTRO_FEATURES:append = " rauc"
RAUC_KEYRING_FILE = "<your-path>/ea-bsp/sources/meta-rauc/scripts/openssl-ca/dev/ca.cert.pem"
```

Now you can build a new image with RAUC support

```
bitbake ea-image-base
```

## Create an update bundle

A RAUC [bundle](https://github.com/embeddedartists/meta-ea/blob/ea-6.1.36/recipes-kernel/linux/linux-ea_6.1.bb#L54)
must be created before updating thw system. It typically consists of the file system 
image(s) and a manifest. 

### RAUC Host Tool

Creating a bundle on the host requires the RAUC host tool. This tool can be built using bitbake.

```
bitbake rauc-native -caddto_recipe_sysroot
```

### Manifest and archives

In this example we are using two tar.gz archives.

- `ea-boot.tar.gz`: Contains the kernel image (`Image`), device tree files (`*.dtb`) and boot script (`boot.scr`).
- `ea-image-base-imx8mmea-ucom.tar.gz`: The root file system generated by bitbake ea-image-base.

These two archives including the [manifest](https://rauc.readthedocs.io/en/latest/reference.html#manifest) 
file (`manifest.raucm`) are put in the folder `rauc-bundle`.

```
[update]
compatible=EA RAUC example
version=2023.12-1

[bundle]
format=verity

[image.rootfs]
filename=ea-image-base-imx8mmea-ucom.tar.gz

[image.boot]
filename=ea-boot.tar.gz
```

Run the RAUC host tool as below to create the bundle.

```
oe-run-native rauc-native rauc --cert ../sources/meta-rauc/scripts/openssl-ca/dev/development-1.cert.pem --key ../sources/meta-rauc/scripts/openssl-ca/dev/private/development-1.key.pem bundle rauc-bundle/ update-2023.12-1.raucb
```

## Update the system

Begin by putting the bundle created above on a USB memory stick or on the system. In this example we 
have it on a USB memory stick. The commands below are run on the system.

Mount the USB memory stick.

```
mount /dev/sda1/ /mnt
```

U-boot environment is put in the eMMC boot partition (e.g. `/dev/mmcblk2boot0`) and this partition
is by default read-only. We need to make it writeable (a helper script us available).

```
/usr/sbin/fw_rw_bootpart.sh unlock
```

Install the update.

```
rauc install /mnt/update-2023.12-1.raucb
```

If successful you can now reboot the system.

```
reboot
```


